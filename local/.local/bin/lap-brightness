#!/usr/bin/env bash
# ~/.local/bin/lap-brightness
# Prints icon+percent on show/up/down/set/min
set -euo pipefail

STEP="${STEP:-10}" # percent step
ICON_LAPTOP="ï„‰"

# parse CSV: name,class,cur,perc,max
# remove '%' and split on ','
read -r _ _ CUR PCT MAX < <(brightnessctl -m |
  tr -d '%' | tr ',' ' ')

case "${1:-show}" in
show)
  echo "$ICON_LAPTOP ${PCT}%"
  exit 0
  ;;
up)
  TARGET=$((CUR + (STEP * MAX) / 100))
  ;;
down)
  TARGET=$((CUR - (STEP * MAX) / 100))
  # allow near-black
  ((TARGET < MAX / 100)) && TARGET=1
  ;;
set)
  VAL=${2:?percent 0-100 required}
  TARGET=$(((VAL * MAX + 50) / 100))
  ;;
min)
  TARGET=1
  ;;
*)
  echo "Usage: lap-brightness {show|up|down|set 0-100|min}" >&2
  exit 2
  ;;
esac

# clamp
((TARGET < 1)) && TARGET=1
((TARGET > MAX)) && TARGET=MAX

brightnessctl set "$TARGET" >/dev/null

# re-read to get exact percent
read -r _ _ _ PCT _ < <(brightnessctl -m |
  tr -d '%' | tr ',' ' ')
echo "$ICON_LAPTOP ${PCT}%"
